---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Dashboard">
  <div class="container mx-auto py-16">
    <h1 id="welcome-message" class="text-4xl font-bold mb-8 text-primary"></h1>
    
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
      <!-- These cards are populated by the client-side script below -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-2 text-secondary">Projects</h3>
        <p id="projects-count" class="text-4xl font-bold">0</p>
      </div>
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-2 text-secondary">Tasks</h3>
        <p id="tasks-count" class="text-4xl font-bold">0</p>
      </div>
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-2 text-secondary">Users</h3>
        <p id="users-count" class="text-4xl font-bold">0</p>
      </div>
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-2 text-secondary">Notifications</h3>
        <p id="notifications-count" class="text-4xl font-bold">0</p>
      </div>
    </div>

    <div class="mt-12">
      <h2 class="text-3xl font-bold mb-6 text-primary">Users</h2>
      <div class="card p-6">
        <table class="w-full text-left">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="py-2">Full Name</th>
              <th class="py-2">Email</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <!-- User data will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

  </div>
</Layout>

<script>
  import { onAuthStateChangedListener } from "../firebase/auth";
  import { getFirestore, collection, getDocs } from "firebase/firestore";
  import { getDatabase, ref, get } from "firebase/database";
  import { app } from "../firebase/client";

  const welcomeMessage = document.getElementById('welcome-message');

  onAuthStateChangedListener(async (user) => {
    if (user) {
      // Personalize the welcome message
      welcomeMessage.textContent = `Welcome back, ${user.displayName || 'User'}!`;

      // User is signed in, fetch dashboard stats
      const rtdb = getDatabase(app);
      const dbRef = ref(rtdb, 'dashboard');
      const snapshot = await get(dbRef);
      const data = snapshot.val();

      if (data) {
        document.getElementById('projects-count').textContent = data.projects || 0;
        document.getElementById('tasks-count').textContent = data.tasks || 0;
        document.getElementById('users-count').textContent = data.users || 0;
        document.getElementById('notifications-count').textContent = data.notifications || 0;
      }

      // Fetch and display users
      const db = getFirestore(app);
      const usersCollection = collection(db, "users");
      const usersSnapshot = await getDocs(usersCollection);
      const usersTableBody = document.getElementById('users-table-body');
      usersTableBody.innerHTML = ''; // Clear existing rows

      usersSnapshot.forEach(doc => {
        const userData = doc.data();
        const row = usersTableBody.insertRow();
        const nameCell = row.insertCell();
        const emailCell = row.insertCell();

        nameCell.textContent = userData.fullName;
        emailCell.textContent = userData.email;
      });

    } else {
      // No user is signed in.
      window.location.href = "/login";
    }
  });
</script>
